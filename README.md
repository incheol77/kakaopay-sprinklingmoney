# 카카오페이 사전과제 - 카카오페이 뿌리기 기능 API 개발
## 목차
- [1. 개발 환경](#1.-개발-환경)
- [2. 빌드 및 실행하기](#2.-빌드-및-실행하기)
- [3. 기능 요구사항](#3.-기능-요구사항)
- [4. 핵심 문제 해결 전략](#4.-핵심-문제-해결-전략)

---

## 1. 개발 환경
- 기본 환경
    - IDE: IntelliJ IDEA
    - OS: Mac OS X
    - GIT
- Server
    - Java11
    - Spring Boot 2.4.0
    - JPA
    - H2
    - lombok
    - Gradle
    - Junit5


## 2. 빌드 및 실행하기
### 터미널 환경
- Java/Git 은 사전에 설치되어 있는 것을 가정한다. (미설치시 별도 설치 필요)

```
$ git clone https://github.com/incheol77/kakaopay-sprinklingmoney.git
$ cd kakaopay-task3 
$ ./gradlew clean build
$ java -jar build/libs/sprinklingmoney-0.0.1-SNAPSHOT.jar
```

- 접속 Base URI: `http://localhost:8080`

## 3. 기능 요구사항
### Introduction  
카카오페이에는 머니 뿌리기 기능이 있습니다.
- 사용자는 다수의 친구들이 있는 대화방에서 뿌릴 금액과 받아갈 대상의 숫자를
입력하여 뿌리기 요청을 보낼 수 있습니다.
- 요청 시 자신의 잔액이 감소되고 대화방에는 뿌리기 메세지가 발송됩니다.
- 대화방에 있는 다른 사용자들은 위에 발송된 메세지를 클릭하여 금액을 무작위로
받아가게 됩니다.

이번 과제에서는 UI 및 메세지 영역은 제외한 간소화된 REST API를 구현하는 것이
목표입니다.


### 요구사항 (개요)
- 뿌리기, 받기, 조회 기능을 수행하는 REST API 를 구현합니다.
    - 요청한 사용자의 식별값은 숫자 형태이며 "X-USER-ID" 라는 HTTP Header로
전달됩니다.
    - 요청한 사용자가 속한 대화방의 식별값은 문자 형태이며 "X-ROOM-ID" 라는
HTTP Header로 전달됩니다.
    - 모든 사용자는 뿌리기에 충분한 잔액을 보유하고 있다고 가정하여 별도로
잔액에 관련된 체크는 하지 않습니다.
- 작성하신 어플리케이션이 다수의 서버에 다수의 인스턴스로 동작하더라도 기능에
문제가 없도록 설계되어야 합니다.
- 각 기능 및 제약사항에 대한 단위테스트를 반드시 작성합니다.

### 상세 구현 요건 및 제약 사항
#### 1. 뿌리기 API
- 뿌릴 금액, 뿌릴 인원을 요청값으로 받습니다.
- 뿌리기 요청건에 대한 고유 token을 발급하고 응답값으로 내려줍니다.
- 뿌릴 금액을 인원수에 맞게 분배하여 저장합니다. (분배 로직은 자유롭게 구현해 주세요.)
- token은 3자리 문자열로 구성되며 예측이 불가능해야 합니다.

#### 2. 받기 API
- 뿌리기 시 발급된 token을 요청값으로 받습니다.
- token에 해당하는 뿌리기 건 중 아직 누구에게도 할당되지 않은 분배건 하나를
API를 호출한 사용자에게 할당하고, 그 금액을 응답값으로 내려줍니다.
- 뿌리기 당한 사용자는 한번만 받을 수 있습니다.
- 자신이 뿌리기한 건은 자신이 받을 수 없습니다.
- 뿌린기가 호출된 대화방과 동일한 대화방에 속한 사용자만이 받을 수
있습니다.
- 뿌린 건은 10분간만 유효합니다. 뿌린지 10분이 지난 요청에 대해서는 받기
실패 응답이 내려가야 합니다.

#### 3. 조회 API
- 뿌리기 시 발급된 token을 요청값으로 받습니다.
- token에 해당하는 뿌리기 건의 현재 상태를 응답값으로 내려줍니다. 현재
상태는 다음의 정보를 포함합니다.
- 뿌린시각, 뿌린금액, 받기완료된금액, 받기완료된정보([받은금액,받은
사용자 아이디] 리스트)
- 뿌린 사람 자신만 조회를 할 수 있습니다. 다른사람의 뿌리기건이나 유효하지
않은 token에 대해서는 조회 실패 응답이 내려가야 합니다.
- 뿌린 건에 대한 조회는 7일 동안 할 수 있습니다.


## 4. 핵심 문제 해결 전략
- 주요 포인트 : 복수의 계좌이체와 유사한 Biz Logic
    - '대화방' 이라는 상황과 '뿌리기' 라는 행위로 인해 자칫 본 업무 요건의 본질을 혼돈하기 쉬울 수 있으나, 
    A라는 '사용자'가 B,C,D 라는 '대화방' 내의 '사용자'들에게 현금('머니')을 전달한다는 행위의 본질은 
    A라는 은행 계좌에서 B,C,D 라는 계좌로 복수의 계좌 이체건을 하나의 트랜잭션내에서 처리하는 것과 
    동일한 것으로 볼 수 있다. (ㄷ
        - ('뿌리기'의 대상인 '머니'를 현금 증감이 필요하지 않은 일반적인 '메시지'로 생각할 경우 사용자-대화방-대화(메시지) 의 기본 구조와도 유사하다)
    - 따라서, 기본적인 Biz Logic 은 '사용자 A의 잔액 감소분 = 사용자 B의 잔액 증가분'
    이며, 이를 대화방 내의 복수의 사용자로 확대하여 '사용자 A의 뿌리기 금액 = 대화방 사용자별 잔액 증가분의 합계'
    로 적용할 것이며, 이때 '머니'가 전달되는 대상 사용자의 목록으로서 '대화방' 을 사용하기로 한다.
    
### Database 설계
- 주요 포인트  
    - '사용자' 가 복수의 '대화방'에 등록 가능 & '대화방' 에는 복수의 '사용자' 가 등록 가능  
        - 따라서 '사용자':'대화방' = M : N 관계 (다대다 관계)를 해소하기 위해서 '참여대화방'이라는 관계 엔터티(테이블)을 사용한다. 
    - '참여대화방' 내에서 발생할 수 있는 복수의 '뿌리기'는 일반적인 '대화방-메시지'의 관계와 동일하게 1:M 관계로 구성한다.
    
- entity
    - '사용자' (user) : '사용자' 의 일반 정보를 저장. ('머니잔액' 포함)
    - '대화방' (chatroom) : '대화방' 의 일반 정보를 저장. ('뿌리기' 등 메시지 관련 정보는 불포함)
    - '참여대화방' (user-chatroom) : '대화방'에 참여하고 있는 '사용자'의 관계 정보를 저장 
    - '뿌리기' (splinkemoney) : '머니뿌리기' 관련 정보를 저장

### Class 설계 (Entity-Controller-Service)

### 핵심 Biz Logic

### API 설계